<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === NEW THEME VARIABLES (from styles.css) === */
        :root {
            --brand-700: #2f6b3a;
            --brand-600: #3f7f46;
            --brand-500: #69a563;
            --accent-500: #b7d334;
            --accent-400: #c9df57;
            --bg: #f7fbf6;
            --surface: #ffffff;
            --text-900: #0d2216;
            --text-700: #254831;
            --text-500: #5b7a67;
            --radius-xl: 18px;
            --radius-md: 10px;
            --shadow-soft: 0 12px 28px rgba(47, 107, 58, 0.10);
            --shadow-hover: 0 18px 40px rgba(47, 107, 58, 0.18);
        }
        /* === END THEME === */

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            background:
                radial-gradient(1200px 800px at 15% 0%, rgba(185, 211, 52, .18) 0%, rgba(185, 211, 52, .06) 40%, transparent 60%),
                radial-gradient(900px 680px at 85% 20%, rgba(63, 127, 70, .12) 0%, rgba(63, 127, 70, .05) 45%, transparent 65%),
                var(--bg);
            background-attachment: fixed;
        }

        .login-card {
            background: var(--surface);
            padding: 2.5rem 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
            width: 100%;
            max-width: 380px;
            border: 1px solid rgba(47,107,58,.16);
            /* Animation */
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            width: 160px;
            height: auto;
            margin: 0 auto 1.5rem;
            display: block;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            width: 24px; height: 24px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .input {
            padding: 10px 12px;
            border: 1px solid rgba(47,107,58,.25);
            border-radius: var(--radius-md);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            font-size: 0.875rem;
            line-height: 1.25rem;
            background: #fff;
            color: var(--text-900);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input:focus {
            border-color: var(--brand-600);
            box-shadow: 0 0 0 3px rgba(63, 127, 70, .2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            padding: 10px 16px;
            border-radius: 20px;
            transition: all 150ms;
            font-size: 0.875rem;
            line-height: 1.25rem;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .btn-primary {
            background-color: var(--brand-600);
            color: white;
            border-color: rgba(47,107,58,.35);
        }
        .btn-primary:hover {
            background-color: var(--brand-500);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .password-container { position: relative; }
        .toggle-password {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-500);
            margin-top: 0.125rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div class="login-card">

    <img src="/assets/logo.png" alt="MPL Telecom Logo" class="login-logo">

    <h1 class="text-2xl font-bold text-center var(--text-900) mb-6" style="color: var(--text-900); font-family: 'Outfit', sans-serif;">
        HRMS Portal Login
    </h1>

    <form id="loginForm" class="space-y-4">
        <div>
            <label for="username" class="block text-sm font-medium" style="color: var(--text-700);">Username</label>
            <input type="text" id="username" name="username" required class="input">
        </div>
        <div>
            <label for="password" class="block text-sm font-medium" style="color: var(--text-700);">Password</label>
            <div class="password-container mt-1">
                <input type="password" id="password" name="password" required class="input pr-10">
                <span class="toggle-password" onclick="togglePasswordVisibility('password', 'toggleIconLogin')">
                        <i class="fa-regular fa-eye" id="toggleIconLogin"></i>
                    </span>
            </div>
        </div>
        <div id="loginError" class="text-red-600 text-sm mt-2 hidden"></div>
        <button type="submit" id="loginSubmitBtn" class="btn btn-primary w-full flex items-center justify-center">
            <span id="loginSubmitText">Login</span>
            <div id="loginSpinner" class="spinner ml-2 hidden"></div>
        </button>
        <p class="text-xs text-center mt-4" style="color: var(--text-500);">
            Forgot password? Please contact the system administrator.
        </p>
    </form>

    <div id="changePasswordSection" class="mt-6 pt-6 border-t hidden" style="border-color: rgba(47,107,58,.16);">
        <h2 class="text-xl font-semibold text-center mb-4" style="color: var(--warning);">Change Required</h2>
        <p class="text-sm text-center mb-4" style="color: var(--text-700);">Please set a new password.</p>
        <form id="changePasswordForm" class="space-y-4">
            <input type="hidden" id="changeUsername">
            <div>
                <label for="newPassword" class="block text-sm font-medium" style="color: var(--text-700);">New Password</label>
                <div class="password-container mt-1">
                    <input type="password" id="newPassword" name="newPassword" required class="input pr-10">
                    <span class="toggle-password" onclick="togglePasswordVisibility('newPassword', 'toggleIconNew')">
                             <i class="fa-regular fa-eye" id="toggleIconNew"></i>
                         </span>
                </div>
            </div>
            <div>
                <label for="confirmPassword" class="block text-sm font-medium" style="color: var(--text-700);">Confirm New Password</label>
                <div class="password-container mt-1">
                    <input type="password" id="confirmPassword" name="confirmPassword" required class="input pr-10">
                    <span class="toggle-password" onclick="togglePasswordVisibility('confirmPassword', 'toggleIconConfirm')">
                             <i class="fa-regular fa-eye" id="toggleIconConfirm"></i>
                         </span>
                </div>
            </div>
            <div id="changePasswordError" class="text-red-600 text-sm mt-2 hidden"></div>
            <button type="submit" id="changeSubmitBtn" class="btn btn-primary w-full flex items-center justify-center">
                <span id="changeSubmitText">Set New Password</span>
                <div id="changeSpinner" class="spinner ml-2 hidden"></div>
            </button>
        </form>
    </div>

    <footer class="text-center text-xs text-gray-400 mt-8 border-t pt-4" style="border-color: rgba(47,107,58,.16); color: var(--text-500);">
        &copy; 2025 Md. Rakibul Islam Ratul <br>
        Sr. Manager, Telecom Service, Metal Plus
    </footer>
</div>

<script>
    // Password Toggle Script (Keep this as inline script for simplicity on login page)
    function togglePasswordVisibility(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input && icon) {
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }
    }
</script>

<script type="module">
    // Login/Change Password Script
    async function apiCallLogin(action, body) {
        const loginBtn = $('loginSubmitBtn');
        const changeBtn = $('changeSubmitBtn');
        const loginSpinner = $('loginSpinner');
        const changeSpinner = $('changeSpinner');
        const loginText = $('loginSubmitText');
        const changeText = $('changeSubmitText');

        const isLoginAction = action === 'loginUser';
        const submitBtn = isLoginAction ? loginBtn : changeBtn;
        const spinner = isLoginAction ? loginSpinner : changeSpinner;
        const btnText = isLoginAction ? loginText : changeText;

        if (submitBtn) submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');
        if (btnText) btnText.classList.add('hidden');

        try {
            const response = await fetch('/api/proxy?action=' + action, { // Ensure correct API endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const responseText = await response.text();

            if (!response.ok) {
                let errorMsg = `Error: ${response.status}`;
                try {
                    const errData = JSON.parse(responseText);
                    errorMsg = errData.error || errData.message || errorMsg;
                } catch (e) { /* Ignore */ }
                throw new Error(errorMsg);
            }
            if (!responseText) return { success: true };
            return JSON.parse(responseText);
        } finally {
            if (submitBtn) submitBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (btnText) btnText.classList.remove('hidden');
        }
    }

    const $ = (id) => document.getElementById(id);
    const loginForm = $('loginForm');
    const loginError = $('loginError');
    const changePasswordSection = $('changePasswordSection');
    const changePasswordForm = $('changePasswordForm');
    const changePasswordError = $('changePasswordError');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.classList.add('hidden');
        changePasswordSection.classList.add('hidden');

        const username = $('username').value;
        const password = $('password').value;

        // --- ADDED LOGGING LINE ---
        console.log('Frontend: Attempting login with:', { username, password });
        // --- END LOGGING ---

        try {
            // Pass the data as an object
            const loginData = { username, password };
            const result = await apiCallLogin('loginUser', loginData);

            if (result.success) {
                if (result.changePasswordRequired) {
                    $('changeUsername').value = username;
                    changePasswordSection.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                } else {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('loggedInUser', username);
                    window.location.href = '/index.html'; // Redirect to main app
                }
            }
        } catch (error) {
             console.error('Login failed:', error);
             loginError.textContent = error.message || 'Login failed. Please try again.';
             if (error.message.includes('User not found') || error.message.includes('Incorrect password')) {
                 loginError.textContent += ' Forgot password? Contact administrator.';
             }
             loginError.classList.remove('hidden');
        }
    });

    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        changePasswordError.classList.add('hidden');

        const username = $('changeUsername').value;
        const newPassword = $('newPassword').value;
        const confirmPassword = $('confirmPassword').value;
        const oldPassword = 'Metal@#357'; // Send default as oldPassword

        if (newPassword !== confirmPassword) {
            changePasswordError.textContent = 'New passwords do not match.';
            changePasswordError.classList.remove('hidden');
            return;
        }
        if (newPassword.length < 6) {
             changePasswordError.textContent = 'Password must be at least 6 characters.';
             changePasswordError.classList.remove('hidden');
             return;
        }

        // --- ADD LOGGING LINE ---
        console.log('Frontend: Attempting password change for:', username);
        // --- END LOGGING ---


        try {
             const changeData = { username, oldPassword, newPassword };
            const result = await apiCallLogin('changePassword', changeData);
            if (result.success) {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('loggedInUser', username);
                window.location.href = '/index.html'; // Redirect to main app
            }
        } catch (error) {
             console.error('Password change failed:', error);
             changePasswordError.textContent = error.message || 'Failed to change password.';
             changePasswordError.classList.remove('hidden');
        }
    });
</script>
</body>
</html>