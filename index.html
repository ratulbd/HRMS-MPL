<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System MPL-TELECOM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25em 0.75em;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-resigned { background-color: #fef9c3; color: #854d0e; }
        .status-terminated { background-color: #fee2e2; color: #991b1b; }
        .status-held { background-color: #ffedd5; color: #9a3412; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">HR Management System</h1>
            <p class="text-slate-500 mt-1">A unified dashboard to manage employees and payroll.</p>
        </header>

        <!-- Main Actions -->
        <div class="flex flex-wrap gap-4 mb-8">
            <button id="addEmployeeBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                Add New Employee
            </button>
            <button id="uploadAttendanceBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                Generate Salary Sheet
            </button>
            <button id="bulkUploadBtn" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors">
                Bulk Upload Employees
            </button>
            <button id="exportDataBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Export Employee Data
            </button>
             <button id="viewSheetsBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-colors">
                View Past Salary Sheets
            </button>
        </div>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="filterName" class="block text-sm font-medium text-slate-600">Search by Name/ID</label>
                    <input type="text" id="filterName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. John Doe or 123">
                </div>
                <div>
                    <label for="filterStatus" class="block text-sm font-medium text-slate-600">Status</label>
                    <select id="filterStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Resigned">Resigned</option>
                        <option value="Terminated">Terminated</option>
                    </select>
                </div>
                <div>
                    <label for="filterDesignation" class="block text-sm font-medium text-slate-600">Designation</label>
                    <select id="filterDesignation" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filterType" class="block text-sm font-medium text-slate-600">Employee Type</label>
                    <select id="filterType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <option>Permanent</option>
                        <option>Casual</option>
                        <option>Contractual</option>
                        <option>Temporary</option>
                    </select>
                </div>
            </div>
             <div class="mt-4 text-right">
                <button id="resetFiltersBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800">Reset Filters</button>
            </div>
        </div>

        <!-- Employee List -->
        <main id="employee-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Employee cards will be dynamically inserted here -->
            <div id="loading" class="col-span-full text-center p-8">
                <p class="text-slate-500">Loading employee data...</p>
            </div>
        </main>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal max-h-[90vh] flex flex-col" id="employeeModalContent">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 flex-shrink-0">Add New Employee</h2>
            <form id="employeeForm" class="flex-grow overflow-y-auto pr-4">
                <input type="hidden" id="employeeDocId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    
                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b">Basic Information</div>
                    <div>
                        <label for="employeeId" class="block text-sm font-medium text-slate-700">Employee ID</label>
                        <input type="text" id="employeeId" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="name" class="block text-sm font-medium text-slate-700">Employee Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="employeeType" class="block text-sm font-medium text-slate-700">Employee Type</label>
                        <select id="employeeType" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Permanent</option>
                            <option>Casual</option>
                            <option>Contractual</option>
                            <option>Temporary</option>
                        </select>
                    </div>
                    <div>
                        <label for="designation" class="block text-sm font-medium text-slate-700">Designation</label>
                        <input type="text" id="designation" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="joiningDate" class="block text-sm font-medium text-slate-700">Joining Date</label>
                        <input type="date" id="joiningDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="workExperience" class="block text-sm font-medium text-slate-700">Work Experience (Years)</label>
                        <input type="number" step="0.5" id="workExperience" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="education" class="block text-sm font-medium text-slate-700">Education</label>
                        <input type="text" id="education" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Project Details</div>
                    <div>
                        <label for="project" class="block text-sm font-medium text-slate-700">Project</label>
                        <input type="text" id="project" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="projectOffice" class="block text-sm font-medium text-slate-700">Project Office</label>
                        <input type="text" id="projectOffice" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="reportProject" class="block text-sm font-medium text-slate-700">Report Project</label>
                        <input type="text" id="reportProject" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="subCenter" class="block text-sm font-medium text-slate-700">Sub Center</label>
                        <input type="text" id="subCenter" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Personal Details</div>
                    <div>
                        <label for="fatherName" class="block text-sm font-medium text-slate-700">Father's Name</label>
                        <input type="text" id="fatherName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="motherName" class="block text-sm font-medium text-slate-700">Mother's Name</label>
                        <input type="text" id="motherName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="personalMobile" class="block text-sm font-medium text-slate-700">Personal Mobile</label>
                        <input type="tel" id="personalMobile" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="dob" class="block text-sm font-medium text-slate-700">Date of Birth</label>
                        <input type="date" id="dob" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="bloodGroup" class="block text-sm font-medium text-slate-700">Blood Group</label>
                        <input type="text" id="bloodGroup" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="address" class="block text-sm font-medium text-slate-700">Address</label>
                        <input type="text" id="address" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="identification" class="block text-sm font-medium text-slate-700">Identification (NID/Birth Cert.)</label>
                        <input type="text" id="identification" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                   
                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Contact & Nominee</div>
                     <div>
                        <label for="nomineeName" class="block text-sm font-medium text-slate-700">Nominee's Name</label>
                        <input type="text" id="nomineeName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="nomineeMobile" class="block text-sm font-medium text-slate-700">Nominee's Mobile</label>
                        <input type="tel" id="nomineeMobile" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="officialMobile" class="block text-sm font-medium text-slate-700">Official Mobile Number</label>
                        <input type="tel" id="officialMobile" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="mobileLimit" class="block text-sm font-medium text-slate-700">Mobile Limit</label>
                        <input type="number" id="mobileLimit" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Salary Details</div>
                     <div>
                        <label for="salary" class="block text-sm font-medium text-slate-700">Gross Salary</label>
                        <input type="number" id="salary" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="bankAccount" class="block text-sm font-medium text-slate-700">Bank Account Number</label>
                        <input type="text" id="bankAccount" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                </div>
                <div class="mt-8 flex justify-end gap-4 flex-shrink-0 pt-4 border-t">
                    <button type="button" id="cancelEmployeeModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 class="text-2xl font-bold mb-2">Bulk Upload Employees</h2>
            <p class="text-slate-500 mb-6">Upload a CSV file with new employee data.</p>
            <form id="bulkUploadForm">
                <div class="space-y-4">
                    <div>
                        <label for="employeeFile" class="block text-sm font-medium text-slate-700">Employee Data File (.csv)</label>
                        <p class="text-xs text-slate-500 mb-1">
                            Required headers: `Employee ID`, `Employee Name`, `Employee Type`, `Designation`, `Joining Date`, `Project`, `Project Office`, `Report Project`, `Sub Center`, `Work Experience (Years)`, `Education`, `Father's Name`, `Mother's Name`, `Personal Mobile Number`, `Date of Birth`, `Blood Group`, `Address`, `Identification`, `Nominee's Name`, `Nominee's Mobile Number`, `Gross Salary`.
                            Optional headers: `Official Mobile Number`, `Mobile Limit`, `Bank Account Number`.
                        </p>
                        <input type="file" id="employeeFile" accept=".csv" required class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    </div>
                </div>
                <div class="mt-8 flex justify-between items-center gap-4">
                    <button type="button" id="downloadTemplateBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800">Download Template</button>
                    <div class="flex gap-4">
                        <button type="button" id="cancelBulkUploadModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                        <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Upload & Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div id="statusChangeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 id="statusChangeTitle" class="text-2xl font-bold mb-6">Update Employee Status</h2>
            <form id="statusChangeForm">
                <input type="hidden" id="statusChangeEmployeeId">
                <input type="hidden" id="statusChangeNewStatus">
                <div class="space-y-4">
                    <div>
                        <label for="separationDate" id="separationDateLabel" class="block text-sm font-medium text-slate-700">Date</label>
                        <input type="date" id="separationDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-slate-700">Remarks (Optional)</label>
                        <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancelStatusChangeModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Employee Details</h2>
            <div id="viewDetailsContent" class="flex-grow overflow-y-auto pr-4">
                <!-- Details will be populated here -->
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0 pt-4 border-t">
                <button type="button" id="closeViewDetailsModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Attendance Upload Modal -->
    <div id="attendanceModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 class="text-2xl font-bold mb-6">Generate Salary Sheet</h2>
            <form id="attendanceForm">
                <div class="space-y-4">
                    <div>
                        <label for="salaryMonth" class="block text-sm font-medium text-slate-700">Select Month</label>
                        <input type="month" id="salaryMonth" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="attendanceFile" class="block text-sm font-medium text-slate-700">Attendance File (.csv)</label>
                         <p class="text-xs text-slate-500 mb-1">Required columns: `employeeId`, `daysPresent`.</p>
                        <input type="file" id="attendanceFile" accept=".csv" required class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancelAttendanceModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Generate Sheet</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Salary Sheet Modal -->
    <div id="salarySheetModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl modal h-full max-h-[90vh] flex flex-col">
            <div class="flex-shrink-0">
                <h2 class="text-2xl font-bold mb-2">Salary Sheet</h2>
                <p id="sheetMonthYear" class="text-slate-500 mb-6"></p>
            </div>
            <div class="flex-grow overflow-y-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Employee ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Gross Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days Present</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Deduction</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Net Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="salarySheetBody" class="bg-white divide-y divide-slate-200">
                        <!-- Salary sheet rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="closeSheetModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>
    
    <!-- View Past Sheets Modal -->
    <div id="viewSheetsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal h-full max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Past Salary Sheets</h2>
            <div id="pastSheetsList" class="flex-grow overflow-y-auto space-y-3">
                 <!-- List of past sheets will go here -->
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="closePastSheetsModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alertModal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm modal text-center">
            <h3 id="alertTitle" class="text-xl font-bold mb-4"></h3>
            <p id="alertMessage" class="text-slate-600 mb-6"></p>
            <button id="alertOkBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm modal text-center">
            <h3 id="confirmTitle" class="text-xl font-bold mb-4">Confirmation</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                 <button id="confirmCancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                 <button id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- UI Element Getters ---
        const $ = (id) => document.getElementById(id);

        // --- Global State ---
        let localEmployees = [];

        // --- API Endpoint ---
        const API_ENDPOINT = '/api';

        // --- Modal Management ---
        const openModal = (modalId) => $(modalId).classList.remove('hidden');
        const closeModal = (modalId) => $(modalId).classList.add('hidden');

        // --- Custom Alert ---
        function customAlert(title, message) {
            $('alertTitle').textContent = title;
            $('alertMessage').textContent = message;
            openModal('alertModal');
        }
        $('alertOkBtn').addEventListener('click', () => closeModal('alertModal'));

        // --- Custom Confirm ---
        let confirmCallback = null;
        function customConfirm(title, message, callback) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = message;
            confirmCallback = callback;
            openModal('confirmModal');
        }
        $('confirmCancelBtn').addEventListener('click', () => {
            confirmCallback = null;
            closeModal('confirmModal');
        });
        $('confirmOkBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
            closeModal('confirmModal');
        });

        // --- Employee Data Handling ---
        async function fetchEmployees() {
            try {
                const response = await fetch(`${API_ENDPOINT}?action=getEmployees`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const employees = await response.json();
                localEmployees = employees;
                populateFilterDropdowns(employees);
                filterAndRenderEmployees();
            } catch (error) {
                console.error("Error fetching employees:", error);
                customAlert("Error", "Could not fetch employee data from the server.");
                const loadingIndicator = $('loading');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = '<p class="text-red-500 font-semibold">Could not load data. Please check the backend setup and your Google Sheet permissions.</p>';
                }
            }
        }
        
        function populateFilterDropdowns(employees) {
            const designationFilter = $('filterDesignation');
            const designations = [...new Set(employees.map(e => e.designation).filter(Boolean))];
            
            const currentVal = designationFilter.value;
            designationFilter.innerHTML = '<option value="">All</option>';
            designations.sort().forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                designationFilter.appendChild(option);
            });
            designationFilter.value = currentVal;
        }

        function filterAndRenderEmployees() {
            const nameFilter = $('filterName').value.toLowerCase();
            const statusFilter = $('filterStatus').value;
            const designationFilter = $('filterDesignation').value;
            const typeFilter = $('filterType').value;

            const filtered = localEmployees.filter(emp => {
                const nameMatch = nameFilter === '' || (emp.name && emp.name.toLowerCase().includes(nameFilter)) || (emp.employeeId && emp.employeeId.toLowerCase().includes(nameFilter));
                const statusMatch = statusFilter === '' || emp.status === statusFilter;
                const designationMatch = designationFilter === '' || emp.designation === designationFilter;
                const typeMatch = typeFilter === '' || emp.employeeType === typeFilter;
                
                return nameMatch && statusMatch && designationMatch && typeMatch;
            });
            renderEmployeeList(filtered);
        }

        function renderEmployeeList(employees) {
            const listContainer = $('employee-list');
            listContainer.innerHTML = '';
            
            const loadingIndicator = $('loading');
            if(loadingIndicator) loadingIndicator.remove();

            if (employees.length === 0) {
                listContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-white rounded-lg shadow"><p class="text-slate-500">No employees found matching the current filters.</p></div>`;
                return;
            }

            employees.forEach(emp => {
                const statusClass = emp.status === 'Active' ? 'status-active' : (emp.status === 'Resigned' ? 'status-resigned' : 'status-terminated');
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 flex flex-col';
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                             <h3 class="text-xl font-bold text-slate-900">${emp.name || 'No Name'}</h3>
                             <span class="status-badge ${statusClass}">${emp.status || 'Active'}</span>
                        </div>
                        <p class="text-slate-500">${emp.designation || 'N/A'}</p>
                        <p class="text-sm text-slate-500 mb-4">ID: ${emp.employeeId || 'N/A'}</p>
                        
                        <div class="text-sm space-y-2">
                           <p><strong>Type:</strong> ${emp.employeeType || 'N/A'}</p>
                           <p><strong>Project:</strong> ${emp.project || 'N/A'}</p>
                           <p><strong>Salary:</strong> ৳${Number(emp.salary || 0).toLocaleString('en-IN')}</p>
                           <p><strong>Joined:</strong> ${emp.joiningDate ? new Date(emp.joiningDate).toLocaleDateString() : 'N/A'}</p>
                           ${emp.status !== 'Active' && emp.separationDate ? `<p><strong>Separation Date:</strong> ${new Date(emp.separationDate).toLocaleDateString()}</p>` : ''}
                        </div>
                        ${emp.salaryHeld ? `<div class="mt-2"><span class="status-badge status-held">Salary Held</span></div>` : ''}
                        ${emp.remarks ? `<div class="mt-2 text-xs text-slate-600 bg-slate-100 p-2 rounded-md"><strong>Remarks:</strong> ${emp.remarks}</div>` : ''}
                    </div>
                    <div class="border-t border-slate-200 mt-4 pt-4 flex flex-wrap gap-2 justify-end">
                         <button class="view-details-btn text-sm font-medium text-gray-600 hover:text-gray-800" data-id="${emp.id}">View Details</button>
                         <button class="edit-btn text-sm font-medium text-blue-600 hover:text-blue-800" data-id="${emp.id}">Edit</button>
                        ${(emp.status || 'Active') === 'Active' ? `
                            <button class="toggle-hold-btn text-sm font-medium ${emp.salaryHeld ? 'text-green-600 hover:text-green-800' : 'text-orange-600 hover:text-orange-800'}" data-id="${emp.id}" data-held="${emp.salaryHeld}">${emp.salaryHeld ? 'Unhold Salary' : 'Hold Salary'}</button>
                            <button class="resign-btn text-sm font-medium text-yellow-600 hover:text-yellow-800" data-id="${emp.id}">Resign</button>
                            <button class="terminate-btn text-sm font-medium text-red-600 hover:text-red-800" data-id="${emp.id}">Terminate</button>
                        ` : ''}
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
        
        // --- Event Listeners for Employee Actions ---
        $('employee-list').addEventListener('click', async (e) => {
            const target = e.target;
            const docId = target.dataset.id;
            if (docId === undefined) return;
            
            const employee = localEmployees.find(emp => emp.id == docId);
            if (!employee) return;
            
            if (target.classList.contains('view-details-btn')) {
                openViewDetailsModal(employee);
            } else if (target.classList.contains('edit-btn')) {
                openEmployeeModal(employee);
            } else if (target.classList.contains('resign-btn')) {
                openStatusChangeModal(employee.employeeId, 'Resigned');
            } else if (target.classList.contains('terminate-btn')) {
                openStatusChangeModal(employee.employeeId, 'Terminated');
            } else if (target.classList.contains('toggle-hold-btn')) {
                const isHeld = target.dataset.held === 'true';
                employee.salaryHeld = !isHeld;
                await saveEmployee(employee);
                fetchEmployees();
            }
        });

        // --- Filter Event Listeners ---
        ['filterName', 'filterStatus', 'filterDesignation', 'filterType'].forEach(id => {
            $(id).addEventListener('input', filterAndRenderEmployees);
        });
        $('resetFiltersBtn').addEventListener('click', () => {
            $('filterName').value = '';
            $('filterStatus').value = '';
            $('filterDesignation').value = '';
            $('filterType').value = '';
            filterAndRenderEmployees();
        });

        // --- Employee Form Modal Logic ---
        function openEmployeeModal(employee = null) {
            $('employeeForm').reset();
            if (employee) {
                $('modalTitle').textContent = 'Edit Employee';
                Object.keys(employee).forEach(key => {
                    const input = $(key);
                    if (input) input.value = employee[key] || '';
                });
                $('employeeId').setAttribute('readonly', true);
                $('employeeId').classList.add('bg-slate-100');
            } else {
                $('modalTitle').textContent = 'Add New Employee';
                $('employeeId').removeAttribute('readonly');
                $('employeeId').classList.remove('bg-slate-100');
            }
            openModal('employeeModal');
        }

        $('addEmployeeBtn').addEventListener('click', () => openEmployeeModal());
        $('cancelEmployeeModal').addEventListener('click', () => closeModal('employeeModal'));

        $('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const employeeData = {};
            new FormData(form).forEach((value, key) => {
                const input = form.querySelector(`[name=${key}]`);
                if(input) employeeData[key] = value;
            });
            // Manual population since FormData doesn't get all fields
            document.querySelectorAll('#employeeForm input, #employeeForm select').forEach(el => {
                if(el.id) employeeData[el.id] = el.value;
            });

            await saveEmployee(employeeData);
            closeModal('employeeModal');
            fetchEmployees();
        });

        async function saveEmployee(employee) {
             try {
                const response = await fetch(`${API_ENDPOINT}?action=saveEmployee`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(employee)
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                customAlert("Success", result.message);
            } catch (error) {
                console.error("Error saving employee:", error);
                customAlert("Error", `Failed to save employee data. ${error.message}`);
            }
        }

        // --- Bulk Upload & Export Logic ---
        $('bulkUploadBtn').addEventListener('click', () => {
            $('bulkUploadForm').reset();
            openModal('bulkUploadModal');
        });
        $('cancelBulkUploadModal').addEventListener('click', () => closeModal('bulkUploadModal'));
        
        $('exportDataBtn').addEventListener('click', () => {
             if (localEmployees.length === 0) {
                customAlert("No Data", "There are no employees to export.");
                return;
            }
            exportEmployeesToCSV();
        });

        function exportEmployeesToCSV() {
            // Use the exact headers from the template
            const headers = getTemplateHeaders();
            const headerKeys = headers.map(h => {
                const normalized = h.toLowerCase().replace(/\(.*\)/g, '').replace(/'/g, '').replace(/\s+/g, '');
                return Object.keys(HEADER_MAPPING).find(key => HEADER_MAPPING[key] === normalized);
            }).filter(Boolean);


            let csvContent = headers.join(',') + '\n';

            localEmployees.forEach(emp => {
                const row = headerKeys.map(key => {
                    let value = emp[key] === undefined || emp[key] === null ? '' : String(emp[key]);
                    if (value.includes(',')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            downloadCSV(csvContent, "employee_data_export.csv");
        }

        function getTemplateHeaders() {
            return [
                "Employee ID", "Employee Name", "Employee Type", "Designation", "Joining Date", 
                "Project", "Project Office", "Report Project", "Sub Center", "Work Experience (Years)", 
                "Education", "Father's Name", "Mother's Name", "Personal Mobile Number", "Date of Birth", 
                "Blood Group", "Address", "Identification", "Nominee's Name", "Nominee's Mobile Number", 
                "Gross Salary", "Official Mobile Number", "Mobile Limit", "Bank Account Number"
            ];
        }
        
        $('downloadTemplateBtn').addEventListener('click', () => {
            const headers = getTemplateHeaders();
            const csvContent = headers.join(',');
            downloadCSV(csvContent, "employee_upload_template.csv");
        });
        
        function downloadCSV(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        $('bulkUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = $('employeeFile').files[0];
            if (!file) return customAlert("Warning", "Please select a file to upload.");

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = event.target.result;
                const newEmployees = parseEmployeeCSV(csvData);
                if (newEmployees && newEmployees.length > 0) {
                    for (const emp of newEmployees) {
                        await saveEmployee(emp);
                    }
                    closeModal('bulkUploadModal');
                    customAlert("Bulk Upload", "Upload process completed.");
                    fetchEmployees();
                }
            };
            reader.readAsText(file);
        });

        function parseEmployeeCSV(data) {
           try {
                const parseCsvLine = (line) => {
                    const values = [];
                    let currentVal = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && (i === 0 || line[i - 1] !== '"')) {
                            inQuotes = !inQuotes;
                            continue;
                        }
                        if (char === ',' && !inQuotes) {
                            values.push(currentVal.replace(/""/g, '"'));
                            currentVal = '';
                        } else {
                            currentVal += char;
                        }
                    }
                    values.push(currentVal.replace(/""/g, '"'));
                    return values;
                };

                const lines = data.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) throw new Error("CSV must have a header and at least one data row.");

                const rawHeader = parseCsvLine(lines.shift());
                const normalizedHeaders = rawHeader.map(h => h.trim().toLowerCase().replace(/\(.*\)/g, '').replace(/'/g, '').replace(/\s+/g, ''));
                
                return lines.map(line => {
                    const values = parseCsvLine(line);
                    const emp = {};
                    normalizedHeaders.forEach((header, i) => {
                        const key = Object.keys(HEADER_MAPPING).find(k => HEADER_MAPPING[k] === header);
                        if (key) {
                            emp[key] = values[i] || '';
                        }
                    });
                    return emp;
                });
            } catch (error) {
                customAlert("CSV Parse Error", `Could not read the file. Error: ${error.message}`);
                return null;
            }
        }
        
        // --- Status Change Modal Logic ---
        function openStatusChangeModal(employeeId, newStatus) {
            $('statusChangeForm').reset();
            $('statusChangeEmployeeId').value = employeeId;
            $('statusChangeNewStatus').value = newStatus;
            $('separationDate').valueAsDate = new Date();

            const title = `Mark as ${newStatus}`;
            const dateLabel = newStatus === 'Resigned' ? 'Resignation Date' : 'Termination Date';
            $('statusChangeTitle').textContent = title;
            $('separationDateLabel').textContent = dateLabel;

            openModal('statusChangeModal');
        }
        $('cancelStatusChangeModal').addEventListener('click', () => closeModal('statusChangeModal'));
        
        $('closeViewDetailsModal').addEventListener('click', () => closeModal('viewDetailsModal'));

        function openViewDetailsModal(employee) {
            const content = $('viewDetailsContent');
            const detailsMap = {
                "Employee ID": employee.employeeId, "Employee Name": employee.name, "Status": employee.status,
                "Employee Type": employee.employeeType, "Designation": employee.designation, "Joining Date": employee.joiningDate,
                "Work Experience (Years)": employee.workExperience, "Education": employee.education, "Project": employee.project,
                "Project Office": employee.projectOffice, "Report Project": employee.reportProject, "Sub Center": employee.subCenter,
                "Father's Name": employee.fatherName, "Mother's Name": employee.motherName, "Personal Mobile": employee.personalMobile,
                "Date of Birth": employee.dob, "Blood Group": employee.bloodGroup, "Address": employee.address,
                "Identification (NID/etc.)": employee.identification, "Nominee's Name": employee.nomineeName, "Nominee's Mobile": employee.nomineeMobile,
                "Official Mobile": employee.officialMobile, "Mobile Limit": employee.mobileLimit,
                "Gross Salary": `₹${Number(employee.salary).toLocaleString('en-IN')}`, "Bank Account": employee.bankAccount,
            };

            let html = '<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">';
            for (const [label, value] of Object.entries(detailsMap)) {
                html += `<div class="border-b pb-2"><dt class="text-sm font-medium text-slate-500">${label}</dt><dd class="mt-1 text-sm text-slate-900">${value || 'N/A'}</dd></div>`;
            }
            html += '</dl>';
            content.innerHTML = html;
            openModal('viewDetailsModal');
        }

        $('statusChangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const employeeId = $('statusChangeEmployeeId').value;
            const employee = localEmployees.find(emp => emp.employeeId === employeeId);
            if (!employee) return customAlert("Error", "Employee not found.");

            employee.status = $('statusChangeNewStatus').value;
            employee.separationDate = $('separationDate').value;
            employee.remarks = $('remarks').value;

            await saveEmployee(employee);
            closeModal('statusChangeModal');
            fetchEmployees();
        });

        // --- Dummy Salary Sheet Logic (for now) ---
        $('uploadAttendanceBtn').addEventListener('click', () => {
             customAlert("Not Implemented", "Salary Sheet generation is not yet connected in this version.");
        });
        
        $('viewSheetsBtn').addEventListener('click', async () => {
            customAlert("Not Implemented", "Viewing past Salary Sheets is not yet connected in this version.");
        });

        // --- Initial Load ---
        fetchEmployees();
        
        // --- Header Key Mappings ---
        const HEADER_MAPPING = {
            employeeId: 'employeeid', name: 'employeename', employeeType: 'employeetype',
            designation: 'designation', joiningDate: 'joiningdate', project: 'project',
            projectOffice: 'projectoffice', reportProject: 'reportproject', subCenter: 'subcenter',
            workExperience: 'workexperience', education: 'education', fatherName: 'fathersname',
            motherName: 'mothersname', personalMobile: 'personalmobilenumber', dob: 'dateofbirth',
            bloodGroup: 'bloodgroup', address: 'address', identification: 'identification',
            nomineeName: 'nomineesname', nomineeMobile: 'nomineesmobilenumber', salary: 'grosssalary',
            officialMobile: 'officialmobilenumber', mobileLimit: 'mobilelimit', bankAccount: 'bankaccountnumber',
            status: 'status', salaryHeld: 'salaryheld', remarks: 'remarks', separationDate: 'separationdate'
        };

    </script>
</body>
</html>

