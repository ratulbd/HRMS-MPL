<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25em 0.75em;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        /* Status Colors */
        .status-active { background-color: #dcfce7; color: #166534; } /* Green */
        .status-held { background-color: #ffedd5; color: #9a3412; } /* Orange */
        .status-resigned { background-color: #fef9c3; color: #854d0e; } /* Yellow */
        .status-terminated { background-color: #fee2e2; color: #991b1b; } /* Red */

        /* Basic loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f; /* Blue */
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex; /* Use flexbox for centering */
            align-items: center;
            justify-content: center;
            z-index: 110; /* Higher than modals */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Overlay for API calls -->
     <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
     </div>


    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">HR Management System</h1>
            <p class="text-slate-500 mt-1">A unified dashboard to manage your employees and payroll.</p>
        </header>

        <!-- Main Actions -->
        <div class="flex flex-wrap gap-4 mb-8">
            <button id="addEmployeeBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                Add New Employee
            </button>
            <button id="uploadAttendanceBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                Generate Salary Sheet
            </button>
            <button id="bulkUploadBtn" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors">
                Bulk Upload Employees
            </button>
            <button id="exportDataBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Export Employee Data
            </button>
             <button id="viewSheetsBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-colors">
                View Past Salary Sheets
            </button>
        </div>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="filterName" class="block text-sm font-medium text-slate-600">Search by Name/ID</label>
                    <input type="text" id="filterName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. John Doe or 123">
                </div>
                <div>
                    <label for="filterStatus" class="block text-sm font-medium text-slate-600">Status</label>
                    <select id="filterStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <option value="Active">Active</option>
                        <option value="Salary Held">Salary Held</option>
                        <option value="Resigned">Resigned</option>
                        <option value="Terminated">Terminated</option>
                    </select>
                </div>
                <div>
                    <label for="filterDesignation" class="block text-sm font-medium text-slate-600">Designation</label>
                    <select id="filterDesignation" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label for="filterType" class="block text-sm font-medium text-slate-600">Employee Type</label>
                    <select id="filterType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">All</option>
                        <option>Permanent</option>
                        <option>Casual</option>
                        <option>Contractual</option>
                        <option>Temporary</option>
                    </select>
                </div>
            </div>
             <div class="mt-4 text-right">
                <button id="resetFiltersBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800">Reset Filters</button>
            </div>
        </div>

        <!-- Employee List -->
        <main id="employee-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Initial Loading Indicator -->
            <div id="initialLoading" class="col-span-full text-center p-8">
                 <div class="spinner"></div>
                <p class="text-slate-500">Loading employee data...</p>
            </div>
            <!-- Employee cards will be dynamically inserted here -->
        </main>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal max-h-[90vh] flex flex-col" id="employeeModalContent">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 flex-shrink-0">Add New Employee</h2>
            <form id="employeeForm" class="flex-grow overflow-y-auto pr-4">
                <input type="hidden" id="employeeDocId">
                <!-- Add hidden fields to preserve status -->
                <input type="hidden" id="employeeStatus">
                <input type="hidden" id="employeeSalaryHeld">
                 <input type="hidden" id="separationDateHidden">
                 <input type="hidden" id="remarksHidden">
                 <input type="hidden" id="originalEmployeeIdHidden"> <!-- Added for robust updates -->


                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">

                    <!-- Mandatory Fields -->
                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b">Basic Information</div>
                    <div>
                        <label for="employeeId" class="block text-sm font-medium text-slate-700">Employee ID</label>
                        <input type="text" id="employeeId" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="name" class="block text-sm font-medium text-slate-700">Employee Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="employeeType" class="block text-sm font-medium text-slate-700">Employee Type</label>
                        <select id="employeeType" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option>Permanent</option>
                            <option>Casual</option>
                            <option>Contractual</option>
                            <option>Temporary</option>
                        </select>
                    </div>
                    <div>
                        <label for="designation" class="block text-sm font-medium text-slate-700">Designation</label>
                        <input type="text" id="designation" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="joiningDate" class="block text-sm font-medium text-slate-700">Joining Date</label>
                        <input type="date" id="joiningDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="workExperience" class="block text-sm font-medium text-slate-700">Work Experience (Years)</label>
                        <input type="number" step="0.5" id="workExperience" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="education" class="block text-sm font-medium text-slate-700">Education</label>
                        <input type="text" id="education" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Project Details</div>
                    <div>
                        <label for="project" class="block text-sm font-medium text-slate-700">Project</label>
                        <input type="text" id="project" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="projectOffice" class="block text-sm font-medium text-slate-700">Project Office</label>
                        <input type="text" id="projectOffice" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="reportProject" class="block text-sm font-medium text-slate-700">Report Project</label>
                        <input type="text" id="reportProject" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="subCenter" class="block text-sm font-medium text-slate-700">Sub Center</label>
                        <input type="text" id="subCenter" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Personal Details</div>
                    <div>
                        <label for="fatherName" class="block text-sm font-medium text-slate-700">Father's Name</label>
                        <input type="text" id="fatherName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="motherName" class="block text-sm font-medium text-slate-700">Mother's Name</label>
                        <input type="text" id="motherName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="personalMobile" class="block text-sm font-medium text-slate-700">Personal Mobile</label>
                        <input type="tel" id="personalMobile" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="dob" class="block text-sm font-medium text-slate-700">Date of Birth</label>
                        <input type="date" id="dob" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="bloodGroup" class="block text-sm font-medium text-slate-700">Blood Group</label>
                        <input type="text" id="bloodGroup" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="address" class="block text-sm font-medium text-slate-700">Address</label>
                        <input type="text" id="address" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="identification" class="block text-sm font-medium text-slate-700">Identification (NID/Birth Cert.)</label>
                        <input type="text" id="identification" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Contact & Nominee</div>
                     <div>
                        <label for="nomineeName" class="block text-sm font-medium text-slate-700">Nominee's Name</label>
                        <input type="text" id="nomineeName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="nomineeMobile" class="block text-sm font-medium text-slate-700">Nominee's Mobile</label>
                        <input type="tel" id="nomineeMobile" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="officialMobile" class="block text-sm font-medium text-slate-700">Official Mobile Number</label>
                        <input type="tel" id="officialMobile" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="mobileLimit" class="block text-sm font-medium text-slate-700">Mobile Limit</label>
                        <input type="number" id="mobileLimit" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="md:col-span-2 font-semibold text-slate-600 pb-1 border-b mt-4">Salary Details</div>
                     <div>
                        <label for="salary" class="block text-sm font-medium text-slate-700">Gross Salary</label>
                        <input type="number" id="salary" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="bankAccount" class="block text-sm font-medium text-slate-700">Bank Account Number</label>
                        <input type="text" id="bankAccount" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                </div>
                <div class="mt-8 flex justify-end gap-4 flex-shrink-0 pt-4 border-t">
                    <button type="button" id="cancelEmployeeModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 class="text-2xl font-bold mb-2">Bulk Upload Employees</h2>
            <p class="text-slate-500 mb-6">Upload a CSV file with new employee data.</p>
            <form id="bulkUploadForm">
                <div class="space-y-4">
                    <div>
                        <label for="employeeFile" class="block text-sm font-medium text-slate-700">Employee Data File (.csv)</label>
                        <p class="text-xs text-slate-500 mb-1">
                            Required headers: `Employee ID`, `Employee Name`, `Employee Type`, `Designation`, `Joining Date`, `Project`, `Project Office`, `Report Project`, `Sub Center`, `Work Experience (Years)`, `Education`, `Father's Name`, `Mother's Name`, `Personal Mobile Number`, `Date of Birth`, `Blood Group`, `Address`, `Identification`, `Nominee's Name`, `Nominee's Mobile Number`, `Gross Salary`.
                            Optional headers: `Official Mobile Number`, `Mobile Limit`, `Bank Account Number`.
                        </p>
                        <input type="file" id="employeeFile" accept=".csv" required class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                    </div>
                </div>
                <div class="mt-8 flex justify-between items-center gap-4">
                    <button type="button" id="downloadTemplateBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800">Download Template</button>
                    <div class="flex gap-4">
                        <button type="button" id="cancelBulkUploadModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                        <button type="submit" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">Upload & Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div id="statusChangeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 id="statusChangeTitle" class="text-2xl font-bold mb-6">Update Employee Status</h2>
            <form id="statusChangeForm">
                <input type="hidden" id="statusChangeEmployeeId">
                <input type="hidden" id="statusChangeNewStatus">
                <div class="space-y-4">
                    <div>
                        <label for="separationDate" id="separationDateLabel" class="block text-sm font-medium text-slate-700">Date</label>
                        <input type="date" id="separationDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="remarks" class="block text-sm font-medium text-slate-700">Remarks (Optional)</label>
                        <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancelStatusChangeModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Employee Details</h2>
            <div id="viewDetailsContent" class="flex-grow overflow-y-auto pr-4">
                <!-- Details will be populated here -->
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0 pt-4 border-t">
                <button type="button" id="closeViewDetailsModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Attendance Upload Modal -->
    <div id="attendanceModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal">
            <h2 class="text-2xl font-bold mb-6">Generate Salary Sheet</h2>
            <form id="attendanceForm">
                <div class="space-y-4">
                    <div>
                        <label for="salaryMonth" class="block text-sm font-medium text-slate-700">Select Month</label>
                        <input type="month" id="salaryMonth" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="attendanceFile" class="block text-sm font-medium text-slate-700">Attendance File (.csv)</label>
                         <p class="text-xs text-slate-500 mb-1">Required columns: `employeeId`, `daysPresent`.</p>
                        <input type="file" id="attendanceFile" accept=".csv" required class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancelAttendanceModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Generate Sheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Salary Sheet Modal -->
    <div id="salarySheetModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-4xl modal h-full max-h-[90vh] flex flex-col">
            <div class="flex-shrink-0">
                <h2 class="text-2xl font-bold mb-2">Salary Sheet</h2>
                <p id="sheetMonthYear" class="text-slate-500 mb-6"></p>
            </div>
            <div class="flex-grow overflow-y-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Employee ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Gross Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Days Present</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Deduction</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Net Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="salarySheetBody" class="bg-white divide-y divide-slate-200">
                        <!-- Salary sheet rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="closeSheetModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- View Past Sheets Modal -->
    <div id="viewSheetsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl modal h-full max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0">Past Salary Sheets</h2>
            <div id="pastSheetsList" class="flex-grow overflow-y-auto space-y-3">
                 <!-- List of past sheets will go here -->
            </div>
            <div class="mt-8 flex justify-end gap-4 flex-shrink-0">
                <button type="button" id="closePastSheetsModal" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm modal text-center">
            <h3 id="alertTitle" class="text-xl font-bold mb-4"></h3>
            <p id="alertMessage" class="text-slate-600 mb-6"></p>
            <button id="alertOkBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[100] flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm modal text-center">
            <h3 id="confirmTitle" class="text-xl font-bold mb-4">Confirmation</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                 <button id="confirmCancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition-colors">Cancel</button>
                 <button id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- UI Element Getters ---
        const $ = (id) => document.getElementById(id);

        // --- Global State ---
        let localEmployees = []; // Local cache of employees
        const API_URL = '/api/proxy'; // Use the proxied API endpoint

         // --- Loading Overlay ---
        const showLoading = () => $('loadingOverlay').classList.remove('hidden');
        const hideLoading = () => $('loadingOverlay').classList.add('hidden');

        // --- Modal Management ---
        const openModal = (modalId) => $(modalId).classList.remove('hidden');
        const closeModal = (modalId) => $(modalId).classList.add('hidden');

        // --- Custom Alert ---
        function customAlert(title, message) {
            $('alertTitle').textContent = title;
            $('alertMessage').textContent = message;
            openModal('alertModal');
        }
        $('alertOkBtn').addEventListener('click', () => closeModal('alertModal'));

        // --- Custom Confirm ---
        let confirmCallback = null;
        function customConfirm(title, message, callback) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = message;
            confirmCallback = callback;
            openModal('confirmModal');
        }
        $('confirmCancelBtn').addEventListener('click', () => {
            confirmCallback = null;
            closeModal('confirmModal');
        });
        $('confirmOkBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
            closeModal('confirmModal');
        });

        // --- API Fetch Helper ---
        async function apiCall(action, method = 'GET', body = null) {
            showLoading(); // Show loading indicator on API call start
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                // Construct URL based on action (handle potential query params within action string)
                const url = action.includes('?') ? `${API_URL}?${action}` : `${API_URL}?action=${action}`;

                console.log(`API Call: ${method} ${url}`, body ? body : ''); // Log API call details

                const response = await window.fetch(url, options);

                const responseText = await response.text(); // Get response text first

                if (!response.ok) {
                    let errorData = { error: `HTTP error! status: ${response.status}`, details: responseText };
                    try {
                         // Try parsing as JSON if possible, otherwise use text
                         const jsonError = JSON.parse(responseText);
                         if (jsonError.error || jsonError.details) {
                              errorData = jsonError;
                         }
                    } catch (e) {
                         // Ignore JSON parse error if response wasn't JSON
                    }
                    console.error("API Error Response:", errorData);
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // Handle successful empty response (e.g., status 204 or empty 200)
                if (!responseText) {
                     console.log(`API Success (${action}): No content`);
                     return { success: true }; // Return a success object if empty
                }

                 // Parse successful JSON response
                 try {
                     const data = JSON.parse(responseText);
                     console.log(`API Success (${action}):`, data);
                     return data;
                 } catch (e) {
                      console.error(`API Error (${action}): Failed to parse successful response as JSON:`, responseText, e);
                     throw new Error("Failed to parse server response.");
                 }

            } catch (error) {
                console.error(`API Call Error (${action}):`, error);
                // Ensure error is re-thrown so caller knows it failed
                throw error;
            } finally {
                 hideLoading(); // Hide loading indicator on API call end/error
            }
        }

        // --- Employee Data Handling ---
        async function fetchEmployees() {
            const initialLoadingIndicator = $('initialLoading');
            const listContainer = $('employee-list');

            // Show initial loading indicator if it exists and hasn't been removed yet
            if (initialLoadingIndicator) initialLoadingIndicator.style.display = 'block';
            // Clear previous employee cards to prevent duplicates during re-fetch
            listContainer.querySelectorAll('.employee-card').forEach(card => card.remove());

            try {
                const employees = await apiCall('getEmployees');
                localEmployees = employees; // Update local cache
                populateFilterDropdowns(employees);
                filterAndRenderEmployees(); // Render the list
            } catch (error) {
                console.error("Error fetching employees:", error);
                customAlert("Error", `Could not fetch employee data: ${error.message}`);
                // Display error message in the list container
                listContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-white rounded-lg shadow"><p class="text-red-500 font-semibold">Could not load data. Please refresh. (${error.message})</p></div>`;
                 // Explicitly remove loading indicator if error occurs AFTER initial setup
                 if (initialLoadingIndicator && initialLoadingIndicator.parentNode) {
                     initialLoadingIndicator.remove();
                 }
            }
            // FINALLY block removed - indicator removal is handled by filterAndRenderEmployees or error display
        }

        function populateFilterDropdowns(employees) {
            const designationFilter = $('filterDesignation');
            // Create Set from valid designations only
            const designations = [...new Set(employees.map(e => e.designation).filter(d => d && typeof d === 'string'))];

            // Preserve the current value if possible
            const currentVal = designationFilter.value;
            designationFilter.innerHTML = '<option value="">All</option>'; // Start fresh
            designations.sort().forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                designationFilter.appendChild(option);
            });
            // Try to restore previous selection
            if (designations.includes(currentVal)) {
                designationFilter.value = currentVal;
            } else {
                 designationFilter.value = ""; // Default to All if previous value no longer exists
            }
        }


        function filterAndRenderEmployees() {
            const listContainer = $('employee-list'); // Get container reference
            const initialLoadingIndicator = $('initialLoading'); // Find indicator

            const nameFilter = $('filterName').value.toLowerCase();
            const statusFilter = $('filterStatus').value;
            const designationFilter = $('filterDesignation').value;
            const typeFilter = $('filterType').value;

            const filtered = localEmployees.filter(emp => {
                 // Basic check for valid employee object structure
                 if (!emp || typeof emp.name !== 'string' || typeof emp.employeeId !== 'string') {
                    console.warn("Filtering out invalid employee object:", emp);
                    return false;
                }

                // Determine the effective status for filtering
                let effectiveStatus = emp.status || 'Active'; // Default to Active if status is missing/empty
                 // Explicitly check for boolean true, or string 'TRUE'
                if (effectiveStatus === 'Active' && (emp.salaryHeld === true || String(emp.salaryHeld).toUpperCase() === 'TRUE')) {
                    effectiveStatus = 'Salary Held';
                }

                const nameMatch = nameFilter === '' || emp.name.toLowerCase().includes(nameFilter) || emp.employeeId.toLowerCase().includes(nameFilter);
                const statusMatch = statusFilter === '' || effectiveStatus === statusFilter;
                const designationMatch = designationFilter === '' || emp.designation === designationFilter;
                const typeMatch = typeFilter === '' || emp.employeeType === typeFilter;

                return nameMatch && statusMatch && designationMatch && typeMatch;
            });

             // Ensure initial loading indicator is removed *before* rendering the list or no-results message
             if (initialLoadingIndicator && initialLoadingIndicator.parentNode === listContainer) {
                 listContainer.removeChild(initialLoadingIndicator);
             }

            renderEmployeeList(listContainer, filtered); // Pass container and filtered list
        }

        function renderEmployeeList(listContainer, employees) { // Accept listContainer as argument
            listContainer.innerHTML = ''; // Clear previous list

            if (employees.length === 0) {
                listContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-white rounded-lg shadow"><p class="text-slate-500">No employees found matching the current filters.</p></div>`;
                return;
            }

            employees.forEach(emp => {
                // Determine status and class
                 let statusText = emp.status || 'Active'; // Default if missing/empty
                let statusClass = 'status-active'; // Default class
                 // Explicitly check for boolean true, or string 'TRUE'
                 const isHeld = (emp.salaryHeld === true || String(emp.salaryHeld).toUpperCase() === 'TRUE');

                if (statusText === 'Active') {
                    if (isHeld) {
                        statusText = 'Salary Held';
                        statusClass = 'status-held';
                    } else {
                        statusClass = 'status-active'; // Already Active
                    }
                } else if (statusText === 'Resigned') {
                    statusClass = 'status-resigned';
                } else if (statusText === 'Terminated') {
                    statusClass = 'status-terminated';
                } else {
                     console.warn(`Unexpected employee status: '${statusText}' for ID ${emp.employeeId}. Defaulting display to Terminated.`);
                     statusText = 'Terminated';
                     statusClass = 'status-terminated';
                }


                const card = document.createElement('div');
                card.className = 'employee-card bg-white rounded-lg shadow-md p-6 flex flex-col';
                card.setAttribute('data-employee-row-id', emp.id);
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                             <h3 class="text-xl font-bold text-slate-900">${emp.name || 'N/A'}</h3>
                             <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <p class="text-slate-500">${emp.designation || 'N/A'}</p>
                        <p class="text-sm text-slate-500 mb-4">ID: ${emp.employeeId || 'N/A'}</p>

                        <div class="text-sm space-y-2">
                           <p><strong>Type:</strong> ${emp.employeeType || 'N/A'}</p>
                           <p><strong>Project:</strong> ${emp.project || 'N/A'}</p>
                           <p><strong>Salary:</strong> â‚¹${Number(emp.salary || 0).toLocaleString('en-IN')}</p>
                           <p><strong>Joined:</strong> ${emp.joiningDate ? new Date(emp.joiningDate + 'T00:00:00Z').toLocaleDateString() : 'N/A'}</p> <!-- Use UTC -->
                           ${statusText !== 'Active' && statusText !== 'Salary Held' && emp.separationDate ? `<p><strong>Separation Date:</strong> ${new Date(emp.separationDate + 'T00:00:00Z').toLocaleDateString()}</p>` : ''} <!-- Use UTC -->
                        </div>
                        ${emp.remarks ? `<div class="mt-2 text-xs text-slate-600 bg-slate-100 p-2 rounded-md"><strong>Remarks:</strong> ${emp.remarks}</div>` : ''}
                    </div>
                    <div class="border-t border-slate-200 mt-4 pt-4 flex flex-wrap gap-2 justify-end">
                         <button class="view-details-btn text-sm font-medium text-gray-600 hover:text-gray-800" data-id="${emp.id}">View Details</button>
                         <button class="edit-btn text-sm font-medium text-blue-600 hover:text-blue-800" data-id="${emp.id}">Edit</button>
                         ${statusText === 'Active' || statusText === 'Salary Held' ? `
                            <button class="toggle-hold-btn text-sm font-medium ${isHeld ? 'text-green-600 hover:text-green-800' : 'text-orange-600 hover:text-orange-800'}" data-id="${emp.id}" data-held="${isHeld}">${isHeld ? 'Unhold Salary' : 'Hold Salary'}</button>
                            <button class="resign-btn text-sm font-medium text-yellow-600 hover:text-yellow-800" data-id="${emp.id}">Resign</button>
                            <button class="terminate-btn text-sm font-medium text-red-600 hover:text-red-800" data-id="${emp.id}">Terminate</button>
                        ` : ''}
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

       // --- Event Listeners for Employee Actions ---
        $('employee-list').addEventListener('click', async (e) => {
            const target = e.target;
             // Use the row ID stored on the card for local lookup
            const cardElement = target.closest('.employee-card');
             if (!cardElement) return; // Clicked outside a card
            const localId = cardElement.dataset.employeeRowId;
            if (!localId) return;

            const employeeIndex = localEmployees.findIndex(emp => emp.id == localId); // Use == for potential string/number mismatch
            if (employeeIndex === -1) {
                console.error("Employee not found in local cache for ID:", localId);
                customAlert("Error", "Could not find employee data. Please refresh.");
                return;
            }
            const employee = localEmployees[employeeIndex];
            const employeeSheetId = employee.employeeId; // Actual ID for API calls
             if (!employeeSheetId) {
                  customAlert("Error", "Employee ID is missing. Cannot perform action.");
                  return;
             }

            // --- Handle Button Clicks ---
            if (target.classList.contains('view-details-btn')) {
                openViewDetailsModal(employee);
            } else if (target.classList.contains('edit-btn')) {
                openEmployeeModal(employee);
            } else if (target.classList.contains('resign-btn')) {
                openStatusChangeModal(employee, 'Resigned');
            } else if (target.classList.contains('terminate-btn')) {
                openStatusChangeModal(employee, 'Terminated');
            } else if (target.classList.contains('toggle-hold-btn')) {
                const isCurrentlyHeld = target.dataset.held === 'true';
                const newHeldStatus = !isCurrentlyHeld;
                 const originalStatus = employee.status; // Store original status for potential rollback


                try {
                    // **Optimistic UI Update**
                    console.log(`Optimistically setting hold status to ${newHeldStatus} for ${employeeSheetId}`);
                    localEmployees[employeeIndex].salaryHeld = newHeldStatus;
                     // If unholding, ensure status becomes Active
                     if (!newHeldStatus) {
                         localEmployees[employeeIndex].status = 'Active';
                     } else {
                          // If holding, ensure status remains Active (it shouldn't change from Hold action)
                          localEmployees[employeeIndex].status = 'Active';
                     }
                    filterAndRenderEmployees(); // Re-render immediately

                    // **API Call**
                    console.log(`Calling API to update hold status to ${newHeldStatus} for ${employeeSheetId}`);
                    await apiCall('updateStatus', 'POST', {
                        employeeId: employeeSheetId,
                        salaryHeld: newHeldStatus // Send boolean
                        // Backend implicitly sets status to 'Active' if only salaryHeld is sent
                    });
                    console.log(`API call successful for hold status update.`);
                    // Optional: Fetch to reconcile silently
                     // fetchEmployees().catch(err => console.error("Re-fetch after hold/unhold failed:", err));

                } catch (error) {
                     console.error(`Error updating hold status for ${employeeSheetId}:`, error);
                    customAlert("Error", `Failed to update salary status: ${error.message}`);
                    // **Rollback UI Update on Error**
                     console.log(`Rolling back UI changes for ${employeeSheetId}.`);
                     localEmployees[employeeIndex].salaryHeld = isCurrentlyHeld; // Revert hold status
                     localEmployees[employeeIndex].status = originalStatus; // Revert status
                     filterAndRenderEmployees(); // Re-render to show original state
                }
            }
        });


        // --- Filter Event Listeners ---
        ['filterName', 'filterStatus', 'filterDesignation', 'filterType'].forEach(id => {
            $(id).addEventListener('input', filterAndRenderEmployees);
        });
        $('resetFiltersBtn').addEventListener('click', () => {
            $('filterName').value = '';
            $('filterStatus').value = '';
            $('filterDesignation').value = '';
            $('filterType').value = '';
            filterAndRenderEmployees();
        });


        // --- Employee Form Modal Logic ---
        function openEmployeeModal(employee = null) {
            $('employeeForm').reset();
            if (employee) {
                // Edit mode
                $('modalTitle').textContent = 'Edit Employee';
                $('employeeDocId').value = employee.id; // Store local cache ID (row number)
                $('originalEmployeeIdHidden').value = employee.employeeId; // Store original ID for API

                // Populate all fields
                Object.keys(employee).forEach(key => {
                    const input = $(key);
                    // Handle hidden fields
                    if (key === 'status') $('employeeStatus').value = employee[key] || 'Active';
                    else if (key === 'salaryHeld') $('employeeSalaryHeld').value = String(employee[key] === true || String(employee[key]).toUpperCase() === 'TRUE'); // Store 'true'/'false'
                    else if (key === 'separationDate') $('separationDateHidden').value = employee[key] || '';
                    else if (key === 'remarks') $('remarksHidden').value = employee[key] || '';
                    // Populate visible form fields
                    else if (input) {
                         // Format date fields correctly
                         if ((key === 'joiningDate' || key === 'dob') && employee[key]) {
                             try {
                                // Handle potential Excel date serial numbers or standard date strings
                                let dateValue = employee[key];
                                if (!isNaN(dateValue) && dateValue > 10000 && dateValue < 60000) { // Likely Excel serial number
                                     // Excel date calculation (adjusting for Excel's leap year bug)
                                     const excelEpoch = new Date(1899, 11, 30); // Excel's epoch start (day 0)
                                     const dateObj = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                                     input.value = dateObj.toISOString().split('T')[0];
                                } else if (typeof dateValue === 'string') {
                                    // Try parsing as standard date string, use UTC to avoid shifts
                                    const dateObj = new Date(dateValue + 'T00:00:00Z');
                                    if (!isNaN(dateObj)) {
                                         input.value = dateObj.toISOString().split('T')[0];
                                    } else {
                                         input.value = ''; // Clear if invalid
                                         console.warn(`Invalid date string for ${key}: ${employee[key]}`);
                                    }
                                } else {
                                     input.value = ''; // Clear if not a number or string
                                }
                             } catch (e) {
                                 input.value = ''; // Clear if any error during date conversion
                                 console.warn(`Error converting date for ${key}: ${employee[key]}`, e);
                             }
                         } else {
                             input.value = employee[key] || '';
                         }
                    }
                });

                // Employee ID should not be editable after creation
                $('employeeId').setAttribute('readonly', true);
                $('employeeId').classList.add('bg-slate-100');

            } else {
                // Add mode
                $('modalTitle').textContent = 'Add New Employee';
                $('employeeDocId').value = ''; // No local ID yet
                $('originalEmployeeIdHidden').value = ''; // No original ID

                // Set defaults for new employee in hidden fields
                $('employeeStatus').value = 'Active';
                $('employeeSalaryHeld').value = 'false'; // Store boolean string 'false'
                $('separationDateHidden').value = '';
                $('remarksHidden').value = '';

                $('employeeId').removeAttribute('readonly');
                $('employeeId').classList.remove('bg-slate-100');
            }
            openModal('employeeModal');
        }


        $('addEmployeeBtn').addEventListener('click', () => openEmployeeModal());
        $('cancelEmployeeModal').addEventListener('click', () => closeModal('employeeModal'));

        $('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = $('employeeDocId').value; // Local cache ID for update detection
            const originalEmployeeId = $('originalEmployeeIdHidden').value; // Original ID for API lookup

            // Gather data from visible form fields
            const employeeData = {
                // If editing, send originalEmployeeId for backend lookup
                ...(originalEmployeeId && { originalEmployeeId: originalEmployeeId }),
                // Send current employeeId (might be same or different if allowed to change - currently not)
                employeeId: $('employeeId').value,
                name: $('name').value,
                employeeType: $('employeeType').value,
                designation: $('designation').value,
                joiningDate: $('joiningDate').value,
                project: $('project').value,
                projectOffice: $('projectOffice').value,
                reportProject: $('reportProject').value,
                subCenter: $('subCenter').value,
                personalMobile: $('personalMobile').value,
                officialMobile: $('officialMobile').value || '',
                mobileLimit: parseFloat($('mobileLimit').value) || 0,
                workExperience: parseFloat($('workExperience').value) || 0,
                education: $('education').value,
                fatherName: $('fatherName').value,
                motherName: $('motherName').value,
                identification: $('identification').value,
                dob: $('dob').value,
                bloodGroup: $('bloodGroup').value,
                address: $('address').value,
                nomineeName: $('nomineeName').value,
                nomineeMobile: $('nomineeMobile').value,
                salary: parseFloat($('salary').value) || 0,
                bankAccount: $('bankAccount').value || '',
                // Preserve existing status/held/remarks/separation from hidden fields
                status: $('employeeStatus').value,
                 // Convert stored string 'true'/'false' back to boolean for API
                salaryHeld: $('employeeSalaryHeld').value === 'true',
                separationDate: $('separationDateHidden').value,
                remarks: $('remarksHidden').value
            };

            // Basic Client-side Validation
            if (!employeeData.employeeId || !employeeData.name || !employeeData.joiningDate) {
                 customAlert("Validation Error", "Employee ID, Name, and Joining Date are required.");
                 return;
            }
            if (isNaN(employeeData.salary)) {
                 customAlert("Validation Error", "Gross Salary must be a valid number.");
                 return;
            }


            try {
                 if (!docId) { // New employee, check for duplicates client-side
                     const empExists = localEmployees.some(emp => emp.employeeId === employeeData.employeeId);
                     if (empExists) {
                         customAlert("Error", "An employee with this ID already exists.");
                         return;
                     }
                      // Ensure status/held are set correctly for a new employee being sent
                     employeeData.status = 'Active';
                     employeeData.salaryHeld = false;
                     employeeData.separationDate = '';
                     employeeData.remarks = '';
                 }

                // Call the unified saveEmployee endpoint
                await apiCall('saveEmployee', 'POST', employeeData);
                customAlert("Success", docId ? "Employee details updated." : "New employee added.");

                closeModal('employeeModal');
                fetchEmployees(); // Re-fetch to update UI and get latest data

            } catch (error) {
                console.error("Error saving employee:", error);
                // Handle specific error like duplicate ID from server
                 if (error.message && error.message.includes('already exists')) {
                      customAlert("Error", error.message);
                 } else {
                      customAlert("Error", `Failed to save employee data: ${error.message}`);
                 }
            }
        });

        // --- Bulk Upload & Export Logic ---
        $('bulkUploadBtn').addEventListener('click', () => {
            $('bulkUploadForm').reset();
            openModal('bulkUploadModal');
        });
        $('cancelBulkUploadModal').addEventListener('click', () => closeModal('bulkUploadModal'));

        $('exportDataBtn').addEventListener('click', () => {
             if (localEmployees.length === 0) {
                customAlert("No Data", "There are no employees to export.");
                return;
            }
            exportEmployeesToCSV();
        });

        function exportEmployeesToCSV() {
            const headers = [
                "Employee ID", "Employee Name", "Employee Type", "Designation", "Joining Date",
                "Project", "Project Office", "Report Project", "Sub Center", "Work Experience (Years)",
                "Education", "Father's Name", "Mother's Name", "Personal Mobile Number", "Date of Birth",
                "Blood Group", "Address", "Identification", "Nominee's Name", "Nominee's Mobile Number",
                "Gross Salary", "Official Mobile Number", "Mobile Limit", "Bank Account Number",
                "Status", "Salary Held", "Separation Date", "Remarks" // Added status fields
            ];

            const headerKeys = [ // Order must match headers
                "employeeId", "name", "employeeType", "designation", "joiningDate",
                "project", "projectOffice", "reportProject", "subCenter", "workExperience",
                "education", "fatherName", "motherName", "personalMobile", "dob",
                "bloodGroup", "address", "identification", "nomineeName", "nomineeMobile",
                "salary", "officialMobile", "mobileLimit", "bankAccount",
                "status", "salaryHeld", "separationDate", "remarks" // Added status fields
            ];

            let csvContent = headers.join(',') + '\n';

            localEmployees.forEach(emp => {
                const row = headerKeys.map(key => {
                     let value = emp[key] === undefined || emp[key] === null ? '' : String(emp[key]);
                     // Ensure boolean TRUE/FALSE for salaryHeld
                     if (key === 'salaryHeld') {
                         value = (emp[key] === true || String(emp[key]).toUpperCase() === 'TRUE') ? 'TRUE' : 'FALSE';
                     }
                    // Basic CSV escaping for values containing commas or quotes
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return `"${value.replace(/"/g, '""')}"`; // Escape quotes by doubling them
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8,' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "employee_data_export.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Clean up blob URL
            }
        }

        $('downloadTemplateBtn').addEventListener('click', () => {
            const headers = [
                // Required
                "Employee ID", "Employee Name", "Employee Type", "Designation", "Joining Date",
                "Project", "Project Office", "Report Project", "Sub Center", "Work Experience (Years)",
                "Education", "Father's Name", "Mother's Name", "Personal Mobile Number", "Date of Birth",
                "Blood Group", "Address", "Identification", "Nominee's Name", "Nominee's Mobile Number",
                "Gross Salary",
                // Optional
                "Official Mobile Number", "Mobile Limit", "Bank Account Number"
                 // Status fields are NOT included in the upload template, handled by actions
            ];

            const csvContent = headers.join(',');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8,' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "employee_upload_template.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                 URL.revokeObjectURL(url); // Clean up blob URL
            }
        });

        $('bulkUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = $('employeeFile').files[0];
            if (!file) {
                customAlert("Warning", "Please select a file to upload.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = event.target.result;
                const newEmployees = parseEmployeeCSV(csvData);
                if (newEmployees && newEmployees.length > 0) {
                    await bulkAddEmployees(newEmployees); // Make sure to await this
                } else if (newEmployees) { // If parsing returned empty array
                     customAlert("Info", "No valid new employees found in the file to upload.");
                     closeModal('bulkUploadModal');
                } // Error handled within parseEmployeeCSV
            };
            reader.readAsText(file);
        });

        function parseEmployeeCSV(data) {
             try {
                // Robust CSV line parser
                const parseCsvLine = (line) => {
                    // Implementation from previous response...
                    const values = [];
                    let currentVal = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuotes && line[i+1] === '"') { currentVal += '"'; i++; }
                            else { inQuotes = !inQuotes; }
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentVal.trim()); currentVal = '';
                        } else { currentVal += char; }
                    }
                    values.push(currentVal.trim());
                    return values;
                };

                const lines = data.split(/[\r\n]+/).filter(line => line.trim() !== '');
                if (lines.length < 1) throw new Error("CSV file is empty or has no header.");

                const rawHeader = parseCsvLine(lines.shift());
                const header = rawHeader.map(h => h.trim().toLowerCase().replace(/\(.*\)/g, '').replace(/'/g, '').replace(/\s+/g, ''));

                const fieldMapping = { /* ... Mapping from previous response ... */
                    employeeId: 'employeeid', name: 'employeename', employeeType: 'employeetype',
                    designation: 'designation', joiningDate: 'joiningdate', project: 'project',
                    projectOffice: 'projectoffice', reportProject: 'reportproject', subCenter: 'subcenter',
                    workExperience: 'workexperience', education: 'education', fatherName: 'fathersname',
                    motherName: 'mothersname', personalMobile: 'personalmobilenumber', dob: 'dateofbirth',
                    bloodGroup: 'bloodgroup', address: 'address', identification: 'identification',
                    nomineeName: 'nomineesname', nomineeMobile: 'nomineesmobilenumber', salary: 'grosssalary',
                    officialMobile: 'officialmobilenumber', mobileLimit: 'mobilelimit', bankAccount: 'bankaccountnumber'
                 };
                 const requiredNormalizedFields = [ /* ... Required fields from previous response ... */
                     'employeeid', 'employeename', 'employeetype', 'designation', 'joiningdate', 'project',
                     'projectoffice', 'reportproject', 'subcenter', 'workexperience', 'education', 'fathersname',
                     'mothersname', 'personalmobilenumber', 'dob', 'bloodgroup', 'address', 'identification',
                     'nomineesname', 'nomineesmobilenumber', 'grosssalary'
                  ];

                const colIndexes = {};
                 for (const key in fieldMapping) {
                     const normalizedHeader = fieldMapping[key];
                     const index = header.indexOf(normalizedHeader);
                     if (index !== -1) colIndexes[key] = index;
                     else if (requiredNormalizedFields.includes(normalizedHeader)) throw new Error(`Missing required column: '${normalizedHeader}'`);
                 }

                return lines.map((line, lineIndex) => {
                    const values = parseCsvLine(line);
                     if (values.length < header.length) {
                         console.warn(`Skipping line ${lineIndex + 2}: Mismatched column count.`); return null;
                     }
                    const empData = {};
                     for (const key in colIndexes) empData[key] = values[colIndexes[key]] ?? '';

                    // Conversions and Defaults
                    empData.workExperience = parseFloat(empData.workExperience) || 0;
                    empData.salary = parseFloat(empData.salary) || 0;
                    empData.mobileLimit = parseFloat(empData.mobileLimit) || 0;
                    // Keep status fields as defaults, they are not expected in upload template
                    empData.status = 'Active';
                    empData.salaryHeld = false;
                    empData.separationDate = '';
                    empData.remarks = '';

                     if (!empData.employeeId || !empData.name || !empData.joiningDate) {
                        console.warn(`Skipping line ${lineIndex + 2}: Missing essential data.`); return null;
                     }
                    return empData;
                }).filter(emp => emp !== null); // Filter out skipped lines
            } catch (error) {
                 customAlert("CSV Parse Error", `Could not read the file. Error: ${error.message}`);
                 console.error("CSV Parsing Detailed Error:", error);
                 return null;
            }
        }


        async function bulkAddEmployees(employees) {
            showLoading(); // Show loading overlay for bulk operation
            const existingIds = new Set(localEmployees.map(emp => emp.employeeId));
            let addedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;
            const promises = []; // Array to hold all API call promises

            for (const emp of employees) {
                if (!emp.employeeId || existingIds.has(emp.employeeId)) {
                    skippedCount++; continue;
                }
                if (!emp.name || !emp.joiningDate || isNaN(emp.salary)) {
                    skippedCount++; continue;
                }

                // Add promise to the array - DON'T await here
                 promises.push(
                     apiCall('saveEmployee', 'POST', emp)
                         .then(() => {
                             addedCount++;
                             existingIds.add(emp.employeeId); // Add locally to prevent duplicates within same batch
                         })
                         .catch(error => {
                             console.error(`Error adding employee via API ${emp.employeeId}:`, error);
                             errorCount++;
                         })
                 );
            }

            // Wait for all API calls to complete
            await Promise.all(promises);

            hideLoading(); // Hide loading overlay
            closeModal('bulkUploadModal');
            customAlert("Bulk Upload Complete", `Added: ${addedCount}. Skipped: ${skippedCount}. Failed: ${errorCount}.`);
            fetchEmployees(); // Refresh the list
        }


        // --- Status Change Modal Logic ---
         function openStatusChangeModal(employee, newStatus) {
            $('statusChangeForm').reset();
            $('statusChangeEmployeeId').value = employee.employeeId; // Use actual Employee ID
            $('statusChangeNewStatus').value = newStatus;

             const today = new Date().toISOString().split('T')[0];
             // Use existing separation date if available, otherwise default to today
             $('separationDate').value = employee.separationDate || today;
            $('remarks').value = employee.remarks || ''; // Use existing remarks

            const title = `Mark as ${newStatus}`;
            const dateLabel = newStatus === 'Resigned' ? 'Resignation Date' : 'Termination Date';
            $('statusChangeTitle').textContent = title;
            $('separationDateLabel').textContent = dateLabel;

            openModal('statusChangeModal');
        }

        $('cancelStatusChangeModal').addEventListener('click', () => closeModal('statusChangeModal'));

        $('closeViewDetailsModal').addEventListener('click', () => closeModal('viewDetailsModal'));

        function openViewDetailsModal(employee) {
            const content = $('viewDetailsContent');
             const isHeld = (employee.salaryHeld === true || String(employee.salaryHeld).toUpperCase() === 'TRUE'); // Check boolean or string
            const detailsMap = {
                "Employee ID": employee.employeeId, "Employee Name": employee.name,
                "Status": employee.status, "Salary Held": isHeld ? 'Yes' : 'No',
                "Employee Type": employee.employeeType, "Designation": employee.designation,
                "Joining Date": employee.joiningDate, "Work Experience (Years)": employee.workExperience,
                "Education": employee.education, "Project": employee.project,
                "Project Office": employee.projectOffice, "Report Project": employee.reportProject,
                "Sub Center": employee.subCenter, "Father's Name": employee.fatherName,
                "Mother's Name": employee.motherName, "Personal Mobile": employee.personalMobile,
                "Date of Birth": employee.dob, "Blood Group": employee.bloodGroup,
                "Address": employee.address, "Identification (NID/etc.)": employee.identification,
                "Nominee's Name": employee.nomineeName, "Nominee's Mobile": employee.nomineeMobile,
                "Official Mobile": employee.officialMobile, "Mobile Limit": employee.mobileLimit,
                "Gross Salary": `â‚¹${Number(employee.salary || 0).toLocaleString('en-IN')}`,
                "Bank Account": employee.bankAccount,
                "Separation Date": employee.separationDate || 'N/A', "Remarks": employee.remarks || 'N/A',
            };

            let html = '<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">';
            for (const [label, value] of Object.entries(detailsMap)) {
                 let displayValue = value;
                 if ((label === "Joining Date" || label === "Date of Birth" || label === "Separation Date") && value && value !== 'N/A') {
                      // Robust date formatting
                     try {
                         let dateObj;
                          // Handle potential Excel dates (numbers between ~30000 and 60000)
                         if (!isNaN(value) && value > 10000 && value < 60000) {
                             const excelEpoch = new Date(1899, 11, 30);
                             dateObj = new Date(excelEpoch.getTime() + value * 24 * 60 * 60 * 1000);
                         } else {
                             // Assume YYYY-MM-DD or parseable string, use UTC
                             dateObj = new Date(String(value) + 'T00:00:00Z');
                         }
                         if (!isNaN(dateObj)) displayValue = dateObj.toLocaleDateString();
                         else displayValue = value; // Show original if invalid
                     } catch (e) { displayValue = value; } // Show original on error
                 }
                html += `
                    <div class="border-b pb-2">
                        <dt class="text-sm font-medium text-slate-500">${label}</dt>
                         <dd class="mt-1 text-sm text-slate-900">${displayValue ?? 'N/A'}</dd>
                    </div>`;
            }
            html += '</dl>';
            content.innerHTML = html;
            openModal('viewDetailsModal');
        }


         $('statusChangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const employeeId = $('statusChangeEmployeeId').value;
            const newStatus = $('statusChangeNewStatus').value;
            const separationDate = $('separationDate').value;
            const remarks = $('remarks').value;

            if (!employeeId || !newStatus || !separationDate) {
                 customAlert("Error", "Missing required information for status update."); return;
            }

            const employeeIndex = localEmployees.findIndex(emp => emp.employeeId === employeeId);
             if (employeeIndex === -1) {
                 customAlert("Error", "Could not find employee locally. Please refresh."); return;
             }
             const originalEmployeeData = { ...localEmployees[employeeIndex] };

            try {
                 // **Optimistic UI Update**
                 console.log(`Optimistically updating status to ${newStatus} for ${employeeId}`);
                 localEmployees[employeeIndex].status = newStatus;
                 localEmployees[employeeIndex].separationDate = separationDate;
                 localEmployees[employeeIndex].remarks = remarks || '';
                 localEmployees[employeeIndex].salaryHeld = false; // Status change always unholds
                 filterAndRenderEmployees(); // Re-render immediately
                 closeModal('statusChangeModal'); // Close modal optimistically


                // **API Call**
                console.log(`Calling API to update status to ${newStatus} for ${employeeId}`);
                await apiCall('updateStatus', 'POST', {
                    employeeId: employeeId,
                    status: newStatus,
                    separationDate: separationDate,
                    remarks: remarks || ''
                    // Backend implicitly sets salaryHeld to FALSE
                });
                console.log(`API call successful for status update.`);
                // Optional: Fetch to reconcile silently
                // fetchEmployees().catch(err => console.error("Re-fetch after status change failed:", err));

            } catch (error) {
                console.error("Error updating employee status:", error);
                customAlert("Error", `Failed to update employee status: ${error.message}`);
                // **Rollback UI Update on Error**
                 console.log(`Rolling back UI changes for ${employeeId}.`);
                 localEmployees[employeeIndex] = originalEmployeeData; // Restore original data
                 filterAndRenderEmployees(); // Re-render to show original state
            }
        });


        // --- Attendance & Salary Sheet Logic ---
        $('uploadAttendanceBtn').addEventListener('click', () => {
             $('attendanceForm').reset();
            const today = new Date(); today.setMonth(today.getMonth() - 1);
            const year = today.getFullYear(); const month = (today.getMonth() + 1).toString().padStart(2, '0');
            $('salaryMonth').value = `${year}-${month}`;
            openModal('attendanceModal');
        });
        $('cancelAttendanceModal').addEventListener('click', () => closeModal('attendanceModal'));

        $('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = $('attendanceFile').files[0];
            const monthYear = $('salaryMonth').value;
            if (!file || !monthYear) { customAlert("Warning", "Please select month and file."); return; }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = event.target.result;
                const attendance = parseAttendanceCSV(csvData);
                if (!attendance) return;
                await generateAndSaveSalarySheet(attendance, monthYear); // await this
            };
            reader.readAsText(file);
        });

        function parseAttendanceCSV(data) {
            try { /* ... Implementation from previous response ... */
                const lines = data.split(/[\r\n]+/).filter(line => line.trim() !== '');
                 if (lines.length < 1) throw new Error("CSV is empty");
                const header = lines.shift().toLowerCase().split(',').map(h => h.trim());
                const idIndex = header.indexOf('employeeid');
                const daysIndex = header.indexOf('dayspresent');
                if (idIndex === -1 || daysIndex === -1) throw new Error("Missing 'employeeId' or 'daysPresent' column.");

                const attendanceMap = new Map();
                lines.forEach(line => {
                    const values = line.split(',');
                     if (values.length > Math.max(idIndex, daysIndex)) {
                         const empId = values[idIndex].trim();
                         const days = parseInt(values[daysIndex].trim(), 10);
                         if (empId && !isNaN(days)) attendanceMap.set(empId, days);
                         else console.warn(`Skipping invalid attendance line: ${line}`);
                     } else console.warn(`Skipping short attendance line: ${line}`);
                });
                return attendanceMap;
            } catch (error) {
                 customAlert("CSV Parse Error", `Could not read attendance file: ${error.message}`);
                 console.error("Attendance CSV Error:", error); return null;
            }
        }

        async function generateAndSaveSalarySheet(attendance, monthYear) {
            const [year, month] = monthYear.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();
            if (daysInMonth <= 0) {
                 customAlert("Error", "Invalid month selected."); return;
            }

            const sheetData = [];
            // Use local cache, filter for Active employees OR those Held (as they might have attendance)
            const relevantEmployees = localEmployees.filter(e => e.status === 'Active' || (e.status === 'Active' && e.salaryHeld === true));


            relevantEmployees.forEach(emp => {
                const daysPresent = attendance.get(emp.employeeId) || 0;
                const grossSalary = parseFloat(emp.salary) || 0;
                let netSalary = 0;
                let deduction = grossSalary;
                let paymentStatus = "Paid";
                // Explicitly check boolean true or string 'TRUE'
                const isHeld = (emp.salaryHeld === true || String(emp.salaryHeld).toUpperCase() === 'TRUE');

                if (isHeld) {
                    netSalary = 0; deduction = grossSalary; paymentStatus = "Held";
                } else {
                    netSalary = Math.round((grossSalary / daysInMonth) * daysPresent);
                    deduction = grossSalary - netSalary;
                }

                sheetData.push({
                    employeeId: emp.employeeId, name: emp.name, salary: grossSalary,
                    daysPresent: daysPresent, deduction: deduction < 0 ? 0 : deduction,
                    netSalary: netSalary < 0 ? 0 : netSalary, status: paymentStatus
                });
            });

            try {
                await apiCall('saveSheet', 'POST', { sheetId: monthYear, sheetData });
                closeModal('attendanceModal');
                displaySalarySheet(sheetData, monthYear);
                customAlert("Success", `Salary sheet for ${monthYear} generated and saved.`);
            } catch (error) {
                console.error("Error saving salary sheet:", error);
                customAlert("Error", `Could not save salary sheet: ${error.message}`);
            }
        }

        function displaySalarySheet(sheetData, monthYear) {
             const date = new Date(`${monthYear}-01T12:00:00Z`); // UTC
            const monthName = date.toLocaleString('default', { month: 'long', timeZone: 'UTC' });
            const year = date.getUTCFullYear();
            $('sheetMonthYear').textContent = `For ${monthName}, ${year}`;
            const tableBody = $('salarySheetBody'); tableBody.innerHTML = '';

            sheetData.forEach(row => {
                 const paymentStatusClass = row.status === 'Held' ? 'status-badge status-held' : 'text-slate-600';
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${row.employeeId || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${row.name || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">â‚¹${Number(row.salary || 0).toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${row.daysPresent || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">â‚¹${Number(row.deduction || 0).toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-700">â‚¹${Number(row.netSalary || 0).toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="${paymentStatusClass}">${row.status || ''}</span></td>
                 `;
                 tableBody.appendChild(tr);
            });
            openModal('salarySheetModal');
        }

        $('closeSheetModal').addEventListener('click', () => closeModal('salarySheetModal'));

        // --- View Past Sheets Logic ---
        $('viewSheetsBtn').addEventListener('click', async () => {
            try {
                const sheets = await apiCall('getPastSheets');
                sheets.sort((a, b) => b.sheetId.localeCompare(a.sheetId)); // Sort desc

                const listEl = $('pastSheetsList'); listEl.innerHTML = '';
                if (sheets.length === 0) {
                    listEl.innerHTML = '<p class="text-slate-500 text-center">No past salary sheets found.</p>';
                } else {
                    sheets.forEach(sheet => {
                         const date = new Date(`${sheet.sheetId}-01T12:00:00Z`); // UTC
                        const monthName = date.toLocaleString('default', { month: 'long', timeZone: 'UTC' });
                        const year = date.getUTCFullYear();
                        const item = document.createElement('div');
                        item.className = "p-4 border rounded-lg flex justify-between items-center";
                        item.innerHTML = `
                            <div>
                                <p class="font-semibold">${monthName}, ${year}</p>
                                <p class="text-sm text-slate-500">Sheet ID: ${sheet.sheetId}</p>
                            </div>
                            <button data-sheetid="${sheet.sheetId}" class="view-past-sheet-btn bg-blue-100 text-blue-800 text-sm font-semibold py-1 px-3 rounded-full hover:bg-blue-200">View</button>
                        `;
                        listEl.appendChild(item);
                    });
                }
                openModal('viewSheetsModal');
            } catch (error) {
                console.error("Error fetching past sheets:", error);
                customAlert("Error", `Could not load past salary sheets: ${error.message}`);
            }
        });

        $('closePastSheetsModal').addEventListener('click', () => closeModal('viewSheetsModal'));

        $('pastSheetsList').addEventListener('click', async (e) => {
             if (e.target.classList.contains('view-past-sheet-btn')) {
                 const sheetId = e.target.dataset.sheetid;
                 try {
                     // Pass sheetId as query parameter within the action string
                     const sheet = await apiCall(`getSheetData&sheetId=${sheetId}`);
                     if (sheet && sheet.sheetData) {
                         closeModal('viewSheetsModal');
                         displaySalarySheet(sheet.sheetData, sheet.sheetId);
                     } else {
                         customAlert("Error", "Could not find data for the selected salary sheet.");
                     }
                 } catch (error) {
                      customAlert("Error", `Could not load sheet '${sheetId}': ${error.message}`);
                 }
             }
        });

        // --- Initial Load ---
        fetchEmployees(); // Start the application by fetching employee data

    </script>
</body>
</html>

